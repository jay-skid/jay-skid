<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Global Poll</title>
  <style>
    body {font-family: system-ui; display:flex; justify-content:center; align-items:center; height:100vh; background:#f5f7fb;}
    .card {background:#fff; padding:20px; border-radius:12px; width:380px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
    h1 {margin:0 0 10px;}
    button {padding:8px 12px; border:none; border-radius:6px; cursor:pointer; background:#0b63d4; color:#fff;}
    button:disabled {opacity:0.6;}
    .bar {height:10px; background:#e9eef8; border-radius:6px; overflow:hidden; margin-top:10px;}
    .bar > i {display:block; height:100%; background:#0b63d4; width:0;}
    .list {font-size:13px; margin-top:6px;}
    .list strong {color:#0b63d4;}
    .controls {margin-top:12px;}
    input {padding:6px; width:100%; margin-bottom:10px; border:1px solid #ccc; border-radius:6px;}
  </style>
</head>
<body>
  <div class="card">
    <h1 id="pollTitle">Loading...</h1>
    <div id="loginArea">
      <p>Enter a username (nickname):</p>
      <input id="usernameInput" placeholder="e.g. Finley" />
      <button id="saveUser">Save Name</button>
    </div>

    <div id="pollArea" style="display:none;">
      <p id="welcome"></p>
      <div>
        <button id="voteA"></button>
        <button id="voteB"></button>
        <button id="changeVote">Change Vote</button>
      </div>

      <p id="results">Loading votes...</p>
      <div class="bar"><i id="bar"></i></div>

      <div class="list" id="aList"></div>
      <div class="list" id="bList"></div>
    </div>
  </div>

  <script>
    // --- EDIT THESE 4 LINES EACH DAY ---
    const POLL_ID = "2025-10-30"; // unique ID for the day or question
    const POLL_TITLE = "Vote: Nick or Maxwell";
    const OPTION_A = "Nick";
    const OPTION_B = "Maxwell";
    // -----------------------------------

    // JSONBin setup
    const BIN_ID = "6902bd0dae596e708f36ddf2";
    const API_KEY = "$2a$10$DQjUOefBBtS19uZtTBy6l.WzDKfr1TAibr5FSE0OW12.UaPj1GQQa";
    const BASE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    // Elements
    const pollTitle = document.getElementById('pollTitle');
    const usernameInput = document.getElementById('usernameInput');
    const saveUserBtn = document.getElementById('saveUser');
    const loginArea = document.getElementById('loginArea');
    const pollArea = document.getElementById('pollArea');
    const welcomeEl = document.getElementById('welcome');
    const voteABtn = document.getElementById('voteA');
    const voteBBtn = document.getElementById('voteB');
    const changeVoteBtn = document.getElementById('changeVote');
    const resultsEl = document.getElementById('results');
    const barEl = document.getElementById('bar');
    const aList = document.getElementById('aList');
    const bList = document.getElementById('bList');

    pollTitle.textContent = POLL_TITLE;
    voteABtn.textContent = `Vote ${OPTION_A}`;
    voteBBtn.textContent = `Vote ${OPTION_B}`;

    // Local storage user
    function getUser() { return localStorage.getItem('poll-username'); }
    function setUser(name) { localStorage.setItem('poll-username', name); }

    // Fetch / save votes
    async function getAllPolls() {
      const res = await fetch(BASE_URL, { headers: { 'X-Master-Key': API_KEY } });
      const data = await res.json();
      return data.record || {};
    }

    async function saveAllPolls(polls) {
      await fetch(BASE_URL, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
        body: JSON.stringify(polls)
      });
    }

    async function getVotes() {
      const all = await getAllPolls();
      if (!all[POLL_ID]) all[POLL_ID] = { [OPTION_A]: [], [OPTION_B]: [] };
      return all[POLL_ID];
    }

    async function saveVotes(votes) {
      const all = await getAllPolls();
      all[POLL_ID] = votes;
      await saveAllPolls(all);
    }

    // Render poll
    async function render() {
      const user = getUser();
      if (!user) return;

      const votes = await getVotes();
      const aVoters = votes[OPTION_A] || [];
      const bVoters = votes[OPTION_B] || [];
      const total = aVoters.length + bVoters.length;
      const pctA = total ? Math.round((aVoters.length / total) * 100) : 0;

      resultsEl.textContent = `${OPTION_A}: ${aVoters.length} | ${OPTION_B}: ${bVoters.length} (Total: ${total})`;
      barEl.style.width = pctA + '%';
      aList.innerHTML = `<strong>${OPTION_A}:</strong> ${aVoters.join(', ') || 'No votes yet'}`;
      bList.innerHTML = `<strong>${OPTION_B}:</strong> ${bVoters.join(', ') || 'No votes yet'}`;

      const votedA = aVoters.includes(user);
      const votedB = bVoters.includes(user);
      voteABtn.disabled = votedA;
      voteBBtn.disabled = votedB;
      changeVoteBtn.disabled = !(votedA || votedB);
    }

    async function vote(option) {
      const user = getUser();
      if (!user) return alert("Please enter a username first.");
      const votes = await getVotes();

      votes[OPTION_A] = (votes[OPTION_A] || []).filter(u => u !== user);
      votes[OPTION_B] = (votes[OPTION_B] || []).filter(u => u !== user);

      votes[option].push(user);
      await saveVotes(votes);
      render();
    }

    async function changeVote() {
      const user = getUser();
      const votes = await getVotes();

      votes[OPTION_A] = (votes[OPTION_A] || []).filter(u => u !== user);
      votes[OPTION_B] = (votes[OPTION_B] || []).filter(u => u !== user);

      await saveVotes(votes);
      render();
    }

    // UI handlers
    saveUserBtn.onclick = () => {
      const name = usernameInput.value.trim();
      if (!name) return alert("Enter a name.");
      setUser(name);
      loginArea.style.display = "none";
      pollArea.style.display = "block";
      welcomeEl.textContent = `Hello, ${name}!`;
      render();
    };

    voteABtn.onclick = () => vote(OPTION_A);
    voteBBtn.onclick = () => vote(OPTION_B);
    changeVoteBtn.onclick = () => changeVote();

    // On load
    const user = getUser();
    if (user) {
      loginArea.style.display = "none";
      pollArea.style.display = "block";
      welcomeEl.textContent = `Hello, ${user}!`;
      render();
    }
  </script>
</body>
</html>
